<div class="simulations">
  <h2>CARLA Simulation Results</h2>

  <!-- Summary Statistics - Compact -->
  <div class="stats-summary">
    <div class="stat-card">
      <h4>Total Simulations</h4>
      <p class="stat-value">{{ totalSimulations }}</p>
    </div>
    <div class="stat-card collision-card">
      <h4>Total Collisions</h4>
      <p class="stat-value">{{ totalCollisions }}</p>
    </div>
    <div class="stat-card safe-card">
      <h4>Total Safe Runs</h4>
      <p class="stat-value">{{ totalSafeRuns }}</p>
    </div>
    <div class="stat-card safety-rate-card">
      <h4>Safety Rate</h4>
      <p class="stat-value">{{ overallSafetyRate | number : '1.1-1' }}%</p>
    </div>
    <div class="stat-card grade-card" [style.background-color]="getGradeColor(overallGradeLevel)">
      <h4>Overall Grade</h4>
      <p class="stat-value grade-value">{{ overallGradeLevel }}</p>
    </div>
  </div>

  <!-- Advanced Statistics Summary - Compact Inline -->
  <div class="advanced-stats-inline">
    <div class="advanced-stat-mini">
      <h4>Speed Stats</h4>
      <div class="mini-stat-row">
        <span>μ:</span><strong>{{ overallSpeedStats.mean | number : '1.2-2' }}</strong>
        <span>σ:</span><strong>{{ overallSpeedStats.std | number : '1.2-2' }}</strong>
        <span>CV:</span><strong>{{ overallSpeedCV | number : '1.1-1' }}%</strong>
      </div>
    </div>
    <div class="advanced-stat-mini">
      <h4>Steering Stats</h4>
      <div class="mini-stat-row">
        <span>μ:</span><strong>{{ overallSteeringStats.mean | number : '1.3-3' }}</strong>
        <span>σ:</span><strong>{{ overallSteeringStats.std | number : '1.3-3' }}</strong>
        <span>CV:</span><strong>{{ overallSteeringCV | number : '1.1-1' }}%</strong>
      </div>
    </div>
    <div class="advanced-stat-mini">
      <h4>Performance</h4>
      <div class="mini-stat-row">
        <span>FPS:</span><strong>{{ overallFPS | number : '1.1-1' }}</strong> <span>Vision:</span
        ><strong>{{ overallProcessingStats.vision?.mean | number : '1.2-2' }}s</strong>
        <span>LLM:</span><strong>{{ overallProcessingStats.llm?.mean | number : '1.2-2' }}s</strong>
      </div>
    </div>
  </div>

  <!-- Charts Grid - Compact Layout -->
  <div class="charts-grid-compact">
    <!-- Main Performance Chart -->
    <div class="chart-container main-chart" *ngIf="barChartData && barChartData.length > 0">
      <h3>Environment Performance</h3>
      <ngx-charts-bar-vertical
        [results]="barChartData"
        [gradient]="gradient"
        [xAxis]="showXAxis"
        [yAxis]="showYAxis"
        [legend]="false"
        [showXAxisLabel]="false"
        [showYAxisLabel]="false"
        [animations]="animations"
        [scheme]="colorScheme"
        [view]="compactBarView"
        (select)="onSelect($event)"
      >
      </ngx-charts-bar-vertical>
    </div>

    <!-- Advanced Metrics -->
    <div class="chart-container compact-chart" *ngIf="speedVarianceData && speedVarianceData.length > 0">
      <h3>Speed Variance</h3>
      <ngx-charts-bar-horizontal
        [results]="speedVarianceData"
        [scheme]="redScheme"
        [animations]="animations"
        [xAxis]="true"
        [yAxis]="true"
        [view]="compactView"
      >
      </ngx-charts-bar-horizontal>
    </div>

    <div class="chart-container compact-chart" *ngIf="steeringVarianceData && steeringVarianceData.length > 0">
      <h3>Steering Variance</h3>
      <ngx-charts-bar-horizontal
        [results]="steeringVarianceData"
        [scheme]="purpleScheme"
        [animations]="animations"
        [xAxis]="true"
        [yAxis]="true"
        [view]="compactView"
      >
      </ngx-charts-bar-horizontal>
    </div>

    <div class="chart-container compact-chart" *ngIf="processingTimeData && processingTimeData.length > 0">
      <h3>Processing Time</h3>
      <ngx-charts-bar-vertical
        [results]="processingTimeData"
        [scheme]="multiColorScheme"
        [animations]="animations"
        [xAxis]="true"
        [yAxis]="true"
        [showXAxisLabel]="false"
        [showYAxisLabel]="false"
        [view]="compactBarView"
      >
      </ngx-charts-bar-vertical>
    </div>
    <div class="chart-container compact-chart" *ngIf="!processingTimeData || processingTimeData.length === 0">
      <h3>Processing Time</h3>
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; font-size: 0.75rem;">
        Not measured in test mode
      </div>
    </div>

    <div class="chart-container compact-chart" *ngIf="fpsData && fpsData.length > 0">
      <h3>FPS by Environment</h3>
      <ngx-charts-bar-horizontal
        [results]="fpsData"
        [scheme]="greenSingleScheme"
        [animations]="animations"
        [xAxis]="true"
        [yAxis]="true"
        [view]="compactView"
      >
      </ngx-charts-bar-horizontal>
    </div>
  </div>

  <!-- Detailed Statistics Table - Collapsible -->
  <div class="detailed-stats-table-collapsible" *ngIf="environments.length > 0">
    <div class="table-header" (click)="toggleTable = !toggleTable">
      <h3>Detailed Environment Statistics</h3>
      <span class="toggle-icon">{{ toggleTable ? '▼' : '▶' }}</span>
    </div>
    <div class="table-content" *ngIf="toggleTable">
      <table>
        <thead>
          <tr>
            <th>Environment</th>
            <th>Speed μ</th>
            <th>Speed σ</th>
            <th>Speed CI (95%)</th>
            <th>Steering μ</th>
            <th>Steering σ</th>
            <th>FPS</th>
            <th>Frames</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let env of environments">
            <td>
              <strong>{{ env.name }}</strong>
            </td>
            <td>{{ env.speedStats?.mean | number : '1.2-2' }}</td>
            <td>{{ env.speedStats?.std | number : '1.2-2' }}</td>
            <td>
              [{{ env.speedStats?.ci_lower | number : '1.2-2' }},
              {{ env.speedStats?.ci_upper | number : '1.2-2' }}]
            </td>
            <td>{{ env.steeringStats?.mean | number : '1.3-3' }}</td>
            <td>{{ env.steeringStats?.std | number : '1.3-3' }}</td>
            <td>{{ env.avgFPS | number : '1.2-2' }}</td>
            <td>{{ env.totalFrames }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
